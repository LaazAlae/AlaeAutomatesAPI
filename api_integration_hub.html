<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement Processing API - Integration Hub</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Statement Processing API</h1>
            <p>Complete Integration Hub & Testing Environment</p>
            
            <div class="mode-toggle">
                <span class="mode-label" id="simLabel">üìö Documentation Mode</span>
                <div class="toggle-switch" id="modeToggle" onclick="toggleMode()">
                    <div class="toggle-slider"></div>
                </div>
                <span class="mode-label" id="realLabel">üî¨ Live Testing Mode</span>
            </div>
            
            <div class="api-info">
                <div>
                    <h3>API Status</h3>
                    <div id="apiStatus" class="status-indicator status-disconnected">
                        üî¥ Disconnected
                    </div>
                </div>
                <div>
                    <h3>Processing Mode</h3>
                    <div id="processingMode" class="status-indicator status-processing">
                        üìö Documentation
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation Mode Content -->
        <div id="documentationMode">
            <div class="card">
                <h2>üìñ Complete Integration Guide</h2>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('overview')">Overview</button>
                        <button class="tab-button" onclick="showTab('endpoints')">API Endpoints</button>
                        <button class="tab-button" onclick="showTab('workflow')">Workflow</button>
                        <button class="tab-button" onclick="showTab('examples')">Code Examples</button>
                        <button class="tab-button" onclick="showTab('security')">Security</button>
                    </div>

                    <div id="overview" class="tab-content active">
                        <h3>üéØ What This API Does</h3>
                        <p>The Statement Processing API processes financial PDF statements and categorizes them using an Excel DNM (Do Not Mail) list. It provides:</p>
                        
                        <ul style="margin: 20px 0; padding-left: 30px;">
                            <li><strong>PDF Text Extraction:</strong> Extracts company information from PDF statements</li>
                            <li><strong>Company Matching:</strong> Fuzzy matches companies against your DNM list</li>
                            <li><strong>Interactive Review:</strong> Prompts for manual review when similarity is unclear</li>
                            <li><strong>Automated Sorting:</strong> Categorizes statements into DNM, Foreign, National Single/Multi</li>
                            <li><strong>File Generation:</strong> Creates split PDFs and processing results</li>
                        </ul>

                        <div class="security-note">
                            <strong>‚ö° Performance:</strong> O(n) linear time complexity, optimized for large files. Memory efficient for Railway deployment.
                        </div>

                        <h3>üîÑ Processing Flow</h3>
                        <div class="integration-steps">
                            <div class="integration-step">
                                <h4>Create Session</h4>
                                <p>Initialize a processing session to track your workflow</p>
                            </div>
                            <div class="integration-step">
                                <h4>Upload Files</h4>
                                <p>Upload PDF statement and Excel DNM list</p>
                            </div>
                            <div class="integration-step">
                                <h4>Process Statements</h4>
                                <p>API extracts and analyzes company information</p>
                            </div>
                            <div class="integration-step">
                                <h4>Manual Review (if needed)</h4>
                                <p>Answer questions about uncertain company matches</p>
                            </div>
                            <div class="integration-step">
                                <h4>Download Results</h4>
                                <p>Get ZIP file with split PDFs and JSON results</p>
                            </div>
                        </div>
                    </div>

                    <div id="endpoints" class="tab-content">
                        <h3>üåê API Endpoints</h3>
                        
                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/health</strong>
                            <p>Check API health and status</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "healthy",
  "service": "statement-processor",
  "sessions": 0
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/v1/session</strong>
                            <p>Create a new processing session</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "session_id": "uuid-here",
  "expires_in": 7200
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/v1/session/{id}/upload</strong>
                            <p>Upload PDF and Excel files</p>
                            <div class="code-block" data-lang="FormData">
FormData:
- pdf: File (PDF statement)
- excel: File (Excel DNM list)</div>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Files uploaded successfully",
  "files": {
    "pdf": {"name": "statements.pdf", "size": 1048576},
    "excel": {"name": "dnm_list.xlsx", "size": 65536}
  }
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/v1/session/{id}/process</strong>
                            <p>Start processing uploaded files</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Processing completed",
  "total_statements": 25,
  "questions_needed": 3
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/v1/session/{id}/questions</strong>
                            <p>Get manual review questions (if any)</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "questions": [
    {
      "id": "question-uuid",
      "company_name": "ABC Corp Inc",
      "similar_to": "ABC Corporation",
      "percentage": "85.5%",
      "current_destination": "Natio Single"
    }
  ],
  "total_statements": 25
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/v1/session/{id}/answers</strong>
                            <p>Submit manual review answers</p>
                            <div class="code-block" data-lang="Request">
{
  "answers": {
    "ABC Corp Inc": "yes",
    "XYZ Company": "no"
  }
}</div>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Answers submitted successfully"
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/v1/session/{id}/download</strong>
                            <p>Download processed results as ZIP file</p>
                            <div class="code-block" data-lang="Response">
Content-Type: application/zip
Content-Disposition: attachment; filename=results.zip

Contains:
- DNM.pdf (companies in DNM list)
- Foreign.pdf (foreign companies)
- natioSingle.pdf (single-page national)
- natioMulti.pdf (multi-page national)
- results.json (processing details)</div>
                        </div>
                    </div>

                    <div id="workflow" class="tab-content">
                        <h3>üîÑ Integration Workflow</h3>
                        
                        <div class="code-block" data-lang="JavaScript">
// Complete workflow example
class StatementProcessor {
  constructor(apiUrl) {
    this.apiUrl = apiUrl;
    this.sessionId = null;
  }

  async processStatements(pdfFile, excelFile) {
    try {
      // 1. Create session
      const sessionResponse = await fetch(`${this.apiUrl}/api/v1/session`, {
        method: 'POST',
        mode: 'cors'
      });
      const sessionData = await sessionResponse.json();
      this.sessionId = sessionData.session_id;

      // 2. Upload files
      const formData = new FormData();
      formData.append('pdf', pdfFile);
      formData.append('excel', excelFile);

      await fetch(`${this.apiUrl}/api/v1/session/${this.sessionId}/upload`, {
        method: 'POST',
        mode: 'cors',
        body: formData
      });

      // 3. Start processing
      const processResponse = await fetch(`${this.apiUrl}/api/v1/session/${this.sessionId}/process`, {
        method: 'POST',
        mode: 'cors'
      });
      const processData = await processResponse.json();

      // 4. Check for manual review questions
      if (processData.questions_needed > 0) {
        const questionsResponse = await fetch(`${this.apiUrl}/api/v1/session/${this.sessionId}/questions`);
        const questionsData = await questionsResponse.json();
        
        // Show questions to user and get answers
        const answers = await this.showQuestionsToUser(questionsData.questions);
        
        // Submit answers
        await fetch(`${this.apiUrl}/api/v1/session/${this.sessionId}/answers`, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers })
        });
      }

      // 5. Download results
      window.open(`${this.apiUrl}/api/v1/session/${this.sessionId}/download`);
      
    } catch (error) {
      console.error('Processing failed:', error);
    }
  }

  async showQuestionsToUser(questions) {
    // Implement your UI for manual review
    const answers = {};
    for (const question of questions) {
      const answer = confirm(`Is "${question.company_name}" the same as "${question.similar_to}"?`);
      answers[question.company_name] = answer ? 'yes' : 'no';
    }
    return answers;
  }
}</div>

                        <h3>üì± Frontend Integration Tips</h3>
                        <ul style="margin: 20px 0; padding-left: 30px;">
                            <li><strong>CORS:</strong> API includes CORS headers for browser requests</li>
                            <li><strong>File Uploads:</strong> Use FormData for multipart file uploads</li>
                            <li><strong>Error Handling:</strong> Check response.ok before processing JSON</li>
                            <li><strong>Session Management:</strong> Store session_id for the workflow duration</li>
                            <li><strong>File Downloads:</strong> Use window.open() or create blob URLs</li>
                        </ul>
                    </div>

                    <div id="examples" class="tab-content">
                        <h3>üíª React Integration Example</h3>
                        <div class="code-block" data-lang="React">
import React, { useState } from 'react';

function StatementProcessor() {
  const [sessionId, setSessionId] = useState(null);
  const [processing, setProcessing] = useState(false);
  const [questions, setQuestions] = useState([]);

  const processFiles = async (pdfFile, excelFile) => {
    setProcessing(true);
    
    try {
      // Create session
      const sessionRes = await fetch('/api/v1/session', { method: 'POST' });
      const session = await sessionRes.json();
      setSessionId(session.session_id);

      // Upload files
      const formData = new FormData();
      formData.append('pdf', pdfFile);
      formData.append('excel', excelFile);
      
      await fetch(`/api/v1/session/${session.session_id}/upload`, {
        method: 'POST',
        body: formData
      });

      // Process
      const processRes = await fetch(`/api/v1/session/${session.session_id}/process`, {
        method: 'POST'
      });
      const processData = await processRes.json();

      if (processData.questions_needed > 0) {
        const questionsRes = await fetch(`/api/v1/session/${session.session_id}/questions`);
        const questionsData = await questionsRes.json();
        setQuestions(questionsData.questions);
      } else {
        downloadResults(session.session_id);
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setProcessing(false);
    }
  };

  const submitAnswers = async (answers) => {
    await fetch(`/api/v1/session/${sessionId}/answers`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answers })
    });
    downloadResults(sessionId);
  };

  const downloadResults = (sessionId) => {
    window.open(`/api/v1/session/${sessionId}/download`);
  };

  return (
    <div>
      {/* Your UI components here */}
    </div>
  );
}</div>

                        <h3>üêç Python Integration Example</h3>
                        <div class="code-block" data-lang="Python">
import requests

class StatementProcessorClient:
    def __init__(self, api_url):
        self.api_url = api_url
        self.session_id = None

    def process_statements(self, pdf_path, excel_path):
        # Create session
        session_response = requests.post(f"{self.api_url}/api/v1/session")
        session_data = session_response.json()
        self.session_id = session_data['session_id']

        # Upload files
        with open(pdf_path, 'rb') as pdf_file, open(excel_path, 'rb') as excel_file:
            files = {
                'pdf': pdf_file,
                'excel': excel_file
            }
            upload_response = requests.post(
                f"{self.api_url}/api/v1/session/{self.session_id}/upload",
                files=files
            )

        # Process
        process_response = requests.post(
            f"{self.api_url}/api/v1/session/{self.session_id}/process"
        )
        process_data = process_response.json()

        # Handle questions if needed
        if process_data.get('questions_needed', 0) > 0:
            questions_response = requests.get(
                f"{self.api_url}/api/v1/session/{self.session_id}/questions"
            )
            questions = questions_response.json()['questions']
            
            # Get user answers (implement your logic)
            answers = self.get_user_answers(questions)
            
            # Submit answers
            requests.post(
                f"{self.api_url}/api/v1/session/{self.session_id}/answers",
                json={'answers': answers}
            )

        # Download results
        download_response = requests.get(
            f"{self.api_url}/api/v1/session/{self.session_id}/download"
        )
        
        with open('results.zip', 'wb') as f:
            f.write(download_response.content)

    def get_user_answers(self, questions):
        # Implement your question handling logic
        answers = {}
        for question in questions:
            user_input = input(f"Is '{question['company_name']}' the same as '{question['similar_to']}'? (y/n): ")
            answers[question['company_name']] = 'yes' if user_input.lower() == 'y' else 'no'
        return answers</div>
                    </div>

                    <div id="security" class="tab-content">
                        <h3>üîí Security & Best Practices</h3>
                        
                        <div class="security-note">
                            <strong>üõ°Ô∏è Security Features:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>File type validation (PDF, Excel only)</li>
                                <li>File size limits (50MB maximum)</li>
                                <li>Session-based processing with automatic cleanup</li>
                                <li>Request timeout protection (5 minutes)</li>
                                <li>Secure filename handling</li>
                                <li>CORS configuration for browser security</li>
                            </ul>
                        </div>

                        <h3>üìã Integration Checklist</h3>
                        <div class="integration-steps">
                            <div class="integration-step">
                                <h4>File Validation</h4>
                                <p>Validate file types and sizes before upload</p>
                                <div class="code-block" data-lang="JavaScript">
// Client-side validation
function validateFiles(pdfFile, excelFile) {
  if (!pdfFile || !pdfFile.name.toLowerCase().endsWith('.pdf')) {
    throw new Error('Invalid PDF file');
  }
  if (!excelFile || !excelFile.name.toLowerCase().match(/\.(xlsx?|xls)$/)) {
    throw new Error('Invalid Excel file');
  }
  if (pdfFile.size > 50 * 1024 * 1024) {
    throw new Error('PDF file too large (max 50MB)');
  }
}</div>
                            </div>
                            
                            <div class="integration-step">
                                <h4>Error Handling</h4>
                                <p>Implement comprehensive error handling</p>
                                <div class="code-block" data-lang="JavaScript">
// Error handling example
async function apiCall(url, options) {
  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    // Show user-friendly error message
    showErrorMessage('Processing failed. Please try again.');
    throw error;
  }
}</div>
                            </div>
                            
                            <div class="integration-step">
                                <h4>Session Management</h4>
                                <p>Handle session lifecycle properly</p>
                                <div class="code-block" data-lang="JavaScript">
// Session cleanup
class SessionManager {
  constructor(apiUrl) {
    this.apiUrl = apiUrl;
    this.sessions = new Set();
  }

  async createSession() {
    const response = await fetch(`${this.apiUrl}/api/v1/session`, { method: 'POST' });
    const data = await response.json();
    this.sessions.add(data.session_id);
    return data.session_id;
  }

  async cleanupSession(sessionId) {
    try {
      await fetch(`${this.apiUrl}/api/v1/session/${sessionId}`, { method: 'DELETE' });
      this.sessions.delete(sessionId);
    } catch (error) {
      console.warn('Session cleanup failed:', error);
    }
  }

  // Cleanup all sessions on page unload
  cleanupAllSessions() {
    this.sessions.forEach(sessionId => this.cleanupSession(sessionId));
  }
}</div>
                            </div>
                        </div>

                        <h3>üöÄ Production Deployment</h3>
                        <ul style="margin: 20px 0; padding-left: 30px;">
                            <li><strong>Environment:</strong> API is optimized for Railway deployment</li>
                            <li><strong>Scaling:</strong> Stateless design allows horizontal scaling</li>
                            <li><strong>Monitoring:</strong> Health check endpoint for load balancers</li>
                            <li><strong>Logs:</strong> Structured logging for debugging</li>
                            <li><strong>Performance:</strong> O(n) time complexity, memory efficient</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Testing Mode Content -->
        <div id="liveTestingMode" style="display: none;">
            <div class="card">
                <h2>üî¨ Live API Testing</h2>
                <p>Test the API with real files and see actual responses</p>
                
                <div class="api-info">
                    <div>
                        <h3>Test with Your Files</h3>
                        <div class="file-upload" onclick="document.getElementById('pdfInput').click()">
                            <div id="pdfStatus">üìÑ Click to select PDF file</div>
                            <input type="file" id="pdfInput" accept=".pdf" style="display: none;" onchange="handleFileSelect('pdf', this)">
                        </div>
                        
                        <div class="file-upload" onclick="document.getElementById('excelInput').click()" style="margin-top: 15px;">
                            <div id="excelStatus">üìä Click to select Excel file</div>
                            <input type="file" id="excelInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect('excel', this)">
                        </div>
                    </div>
                    <div>
                        <h3>Processing Progress</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div id="progressText">Ready to start...</div>
                        
                        <button class="button" id="startProcessing" onclick="startLiveProcessing()" disabled>
                            üöÄ Start Processing
                        </button>
                    </div>
                </div>
            </div>

            <div class="card" id="questionsCard" style="display: none;">
                <h2>‚ùì Manual Review Required</h2>
                
                <div class="questions-header">
                    <div>
                        <h3 style="margin: 0; color: #856404;">Manual Review Questions</h3>
                        <p style="margin: 5px 0 0 0; color: #856404;">Review company matches and confirm if they're the same entity</p>
                    </div>
                    <button class="button" id="skipAllBtn" onclick="skipAllQuestions()" style="background: #6c757d;">
                        ‚è≠Ô∏è Skip All
                    </button>
                </div>
                
                <div class="questions-container" id="questionsList">
                    <!-- Questions will be populated here -->
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="button success" id="submitAnswers" onclick="submitManualAnswers()" disabled>
                        ‚úÖ Submit Answers
                    </button>
                    <button class="button" onclick="clearAllAnswers()" style="background: #6c757d;">
                        üîÑ Clear All
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>üìä API Responses</h2>
                <div id="responseContainer">
                    <p>Start processing to see API responses...</p>
                </div>
            </div>

            <div class="card">
                <h2>üìã Activity Log</h2>
                <div class="log-container" id="liveLogContainer"></div>
                <button class="button secondary" onclick="clearLiveLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isLiveMode = false;
        let currentSessionId = null;
        let selectedFiles = { pdf: null, excel: null };
        let userAnswers = {};

        // Mode toggle functionality
        function toggleMode() {
            isLiveMode = !isLiveMode;
            const toggle = document.getElementById('modeToggle');
            const simLabel = document.getElementById('simLabel');
            const realLabel = document.getElementById('realLabel');
            const docMode = document.getElementById('documentationMode');
            const liveMode = document.getElementById('liveTestingMode');
            const processingMode = document.getElementById('processingMode');

            if (isLiveMode) {
                toggle.classList.add('active');
                simLabel.classList.remove('active');
                realLabel.classList.add('active');
                docMode.style.display = 'none';
                liveMode.style.display = 'block';
                processingMode.innerHTML = 'üî¨ Live Testing';
                processingMode.className = 'status-indicator status-processing';
                testAPIConnection();
            } else {
                toggle.classList.remove('active');
                simLabel.classList.add('active');
                realLabel.classList.remove('active');
                docMode.style.display = 'block';
                liveMode.style.display = 'none';
                processingMode.innerHTML = 'üìö Documentation';
                processingMode.className = 'status-indicator status-processing';
            }
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // API connection test
        async function testAPIConnection() {
            const apiStatus = document.getElementById('apiStatus');
            
            try {
                const response = await fetch('https://web-production-7ca0.up.railway.app/health');
                if (response.ok) {
                    const data = await response.json();
                    apiStatus.innerHTML = 'üü¢ Connected to Real API';
                    apiStatus.className = 'status-indicator status-connected';
                    liveLog('Connected to real processing API', 'success');
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                apiStatus.innerHTML = 'üî¥ API Disconnected';
                apiStatus.className = 'status-indicator status-disconnected';
                liveLog('Failed to connect to API. Make sure the server is running on port 9000.', 'error');
            }
        }

        // Live logging
        function liveLog(message, type = 'info') {
            const logContainer = document.getElementById('liveLogContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLiveLog() {
            document.getElementById('liveLogContainer').innerHTML = '';
            liveLog('Log cleared', 'info');
        }

        // File handling
        function handleFileSelect(type, input) {
            const file = input.files[0];
            if (file) {
                selectedFiles[type] = file;
                const statusElement = document.getElementById(`${type}Status`);
                const icon = type === 'pdf' ? 'üìÑ' : 'üìä';
                statusElement.innerHTML = `${icon} ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
                liveLog(`Selected ${type.toUpperCase()}: ${file.name}`, 'info');
                
                // Enable start button if both files selected
                if (selectedFiles.pdf && selectedFiles.excel) {
                    document.getElementById('startProcessing').disabled = false;
                }
            }
        }

        // Update progress
        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percent}%`;
            progressText.textContent = message;
            
            liveLog(`Progress: ${percent}% - ${message}`, 'info');
        }

        // Show API response
        function showAPIResponse(title, data, endpoint) {
            const container = document.getElementById('responseContainer');
            
            const responseDiv = document.createElement('div');
            responseDiv.className = 'response-viewer';
            responseDiv.innerHTML = `
                <div class="response-header">${title}</div>
                <div style="margin-bottom: 10px;">
                    <strong>Endpoint:</strong> <code>${endpoint}</code>
                </div>
                <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
            `;
            
            container.appendChild(responseDiv);
        }

        // Main processing function
        async function startLiveProcessing() {
            try {
                updateProgress(0, 'Starting processing...');
                document.getElementById('startProcessing').disabled = true;
                
                // 1. Create session
                updateProgress(10, 'Creating session...');
                const sessionResponse = await fetch('https://web-production-7ca0.up.railway.app/api/v1/session', {
                    method: 'POST',
                    mode: 'cors'
                });
                const sessionData = await sessionResponse.json();
                currentSessionId = sessionData.session_id;
                
                showAPIResponse('Session Created', sessionData, 'POST /api/v1/session');
                liveLog(`Session created: ${currentSessionId.substring(0, 8)}...`, 'success');

                // 2. Upload files
                updateProgress(30, 'Uploading files...');
                const formData = new FormData();
                formData.append('pdf', selectedFiles.pdf);
                formData.append('excel', selectedFiles.excel);

                const uploadResponse = await fetch(`https://web-production-7ca0.up.railway.app/api/v1/session/${currentSessionId}/upload`, {
                    method: 'POST',
                    mode: 'cors',
                    body: formData
                });
                const uploadData = await uploadResponse.json();
                
                showAPIResponse('Files Uploaded', uploadData, `POST /api/v1/session/{id}/upload`);
                liveLog('Files uploaded successfully', 'success');

                // 3. Process statements
                updateProgress(60, 'Processing statements...');
                const processResponse = await fetch(`https://web-production-7ca0.up.railway.app/api/v1/session/${currentSessionId}/process`, {
                    method: 'POST',
                    mode: 'cors'
                });
                const processData = await processResponse.json();
                
                showAPIResponse('Processing Results', processData, `POST /api/v1/session/{id}/process`);
                liveLog(`Processing completed: ${processData.total_statements} statements, ${processData.questions_needed} questions`, 'success');

                // 4. Check for questions
                if (processData.questions_needed > 0) {
                    updateProgress(80, 'Getting manual review questions...');
                    const questionsResponse = await fetch(`https://web-production-7ca0.up.railway.app/api/v1/session/${currentSessionId}/questions`);
                    const questionsData = await questionsResponse.json();
                    
                    showAPIResponse('Manual Review Questions', questionsData, `GET /api/v1/session/{id}/questions`);
                    showQuestions(questionsData.questions);
                    updateProgress(90, 'Manual review required...');
                } else {
                    updateProgress(100, 'Processing complete! Ready for download.');
                    enableDownload();
                }

            } catch (error) {
                liveLog(`Processing failed: ${error.message}`, 'error');
                updateProgress(0, 'Processing failed');
                document.getElementById('startProcessing').disabled = false;
            }
        }

        // Show manual review questions
        function showQuestions(questions) {
            const questionsCard = document.getElementById('questionsCard');
            const questionsList = document.getElementById('questionsList');
            
            questionsCard.style.display = 'block';
            questionsList.innerHTML = '';
            userAnswers = {};

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                // Escape quotes for onclick handlers
                const escapedCompanyName = question.company_name.replace(/'/g, "\\'");
                
                questionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #2c3e50;">Question ${index + 1} of ${questions.length}</h4>
                        <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                            ${question.percentage} match
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>Found Company:</strong> <code>${question.company_name}</code></p>
                        <p style="margin: 8px 0;"><strong>Similar to DNM:</strong> <code>${question.similar_to}</code></p>
                        <p style="margin: 8px 0;"><strong>Current Destination:</strong> <span style="background: #f8f9fa; padding: 2px 8px; border-radius: 4px;">${question.current_destination}</span></p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>‚ùì Are these the same company?</strong>
                        <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9rem;">If they're the same, it will be moved to the DNM list.</p>
                    </div>
                    
                    <div class="question-buttons">
                        <button class="button success" onclick="setAnswer('${escapedCompanyName}', 'yes', ${index})">
                            ‚úÖ Yes - Same Company
                        </button>
                        <button class="button danger" onclick="setAnswer('${escapedCompanyName}', 'no', ${index})">
                            ‚ùå No - Different
                        </button>
                        <button class="button" onclick="setAnswer('${escapedCompanyName}', 'skip', ${index})" style="background: #6c757d;">
                            ‚è≠Ô∏è Skip This One
                        </button>
                    </div>
                    
                    <div id="answer-${index}" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                `;
                questionsList.appendChild(questionDiv);
            });

            liveLog(`Showing ${questions.length} manual review questions in scrollable container`, 'info');
        }

        // Set answer for a question
        function setAnswer(companyName, answer, questionIndex) {
            userAnswers[companyName] = answer;
            
            const answerDiv = document.getElementById(`answer-${questionIndex}`);
            const answerText = answer === 'yes' ? '‚úÖ Same Company - Will move to DNM list' : 
                             answer === 'no' ? '‚ùå Different Company - Will keep current destination' : 
                             '‚è≠Ô∏è Skipped - Will use default categorization';
            
            const bgColor = answer === 'yes' ? '#d4edda' : answer === 'no' ? '#f8d7da' : '#e2e3e5';
            const textColor = answer === 'yes' ? '#155724' : answer === 'no' ? '#721c24' : '#383d41';
            
            answerDiv.style.display = 'block';
            answerDiv.style.background = bgColor;
            answerDiv.style.color = textColor;
            answerDiv.style.border = `1px solid ${answer === 'yes' ? '#c3e6cb' : answer === 'no' ? '#f5c6cb' : '#d1d3d4'}`;
            answerDiv.innerHTML = `<strong>${answerText}</strong>`;
            
            liveLog(`Answer set for "${companyName}": ${answer}`, 'info');
            
            // Enable submit button
            document.getElementById('submitAnswers').disabled = false;
            
            // Update header to show progress
            updateQuestionsProgress();
        }

        // Update questions progress
        function updateQuestionsProgress() {
            const totalQuestions = document.querySelectorAll('.question-item').length;
            const answeredQuestions = Object.keys(userAnswers).length;
            
            const headerElement = document.querySelector('.questions-header h3');
            if (headerElement) {
                headerElement.textContent = `Manual Review Questions (${answeredQuestions}/${totalQuestions} answered)`;
            }
        }

        // Skip all questions
        function skipAllQuestions() {
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                const companyNameElement = item.querySelector('code');
                if (companyNameElement) {
                    const companyName = companyNameElement.textContent;
                    setAnswer(companyName, 'skip', index);
                }
            });
            
            liveLog('All questions skipped', 'warning');
        }

        // Clear all answers
        function clearAllAnswers() {
            userAnswers = {};
            
            // Hide all answer divs
            document.querySelectorAll('[id^="answer-"]').forEach(div => {
                div.style.display = 'none';
            });
            
            // Disable submit button
            document.getElementById('submitAnswers').disabled = true;
            
            // Update progress
            updateQuestionsProgress();
            
            liveLog('All answers cleared', 'info');
        }

        // Submit manual answers
        async function submitManualAnswers() {
            try {
                updateProgress(95, 'Submitting answers...');
                
                const answersResponse = await fetch(`https://web-production-7ca0.up.railway.app/api/v1/session/${currentSessionId}/answers`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: userAnswers })
                });
                const answersData = await answersResponse.json();
                
                showAPIResponse('Answers Submitted', { answers: userAnswers, response: answersData }, `POST /api/v1/session/{id}/answers`);
                liveLog(`Answers submitted: ${Object.keys(userAnswers).length} responses`, 'success');
                
                updateProgress(100, 'Processing complete! Ready for download.');
                enableDownload();
                
                document.getElementById('questionsCard').style.display = 'none';
                
            } catch (error) {
                liveLog(`Answer submission failed: ${error.message}`, 'error');
            }
        }

        // Enable download
        function enableDownload() {
            const responseContainer = document.getElementById('responseContainer');
            const downloadDiv = document.createElement('div');
            downloadDiv.className = 'response-viewer';
            downloadDiv.innerHTML = `
                <div class="response-header">üì• Download Results</div>
                <p>Processing complete! Click below to download your results.</p>
                <button class="button success" onclick="downloadResults()">
                    üì¶ Download ZIP File
                </button>
                <div style="margin-top: 15px;">
                    <strong>Download URL:</strong><br>
                    <code>GET /api/v1/session/${currentSessionId}/download</code>
                </div>
            `;
            responseContainer.appendChild(downloadDiv);
        }

        // Download results
        function downloadResults() {
            const downloadUrl = `https://web-production-7ca0.up.railway.app/api/v1/session/${currentSessionId}/download`;
            window.open(downloadUrl);
            liveLog('Download initiated', 'success');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-test API connection if in live mode
            if (isLiveMode) {
                testAPIConnection();
            }
        });
    </script>
</body>
</html>