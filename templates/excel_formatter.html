<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Formatter - Integration Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">AlaeAutomates <span style="font-size: 0.8em; opacity: 0.7; font-weight: 300;">API</span></a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/monthly-statements" class="nav-link">Monthly Statements</a>
                <a href="/invoice-separator" class="nav-link">Invoice Separator</a>
                <a href="/credit-card-batch" class="nav-link">Credit Card Batch</a>
                <a href="/excel-formatter" class="nav-link active">Excel Formatter</a>
            </div>
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()" aria-label="Toggle navigation">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Excel Formatter</h1>
            <p class="page-subtitle">Professional Integration Hub for Excel Column Header Detection and Formatting</p>

            <div class="mode-toggle">
                <span class="mode-label" id="simLabel">Documentation</span>
                <div class="toggle-switch" id="modeToggle" onclick="toggleMode()" role="button" tabindex="0" aria-label="Toggle between documentation and live testing mode" onkeydown="if(event.key==='Enter'||event.key===' '){toggleMode()}">
                    <div class="toggle-slider"></div>
                </div>
                <span class="mode-label" id="realLabel">Live Testing</span>
            </div>
        </div>

        <!-- Status Section -->
        <div class="content-section">
            <h2 class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
                System Status
            </h2>

            <div class="status-grid">
                <div class="status-card">
                    <h3>API Status</h3>
                    <div id="apiStatus" class="status-indicator status-disconnected">
                        Disconnected
                    </div>
                    <div id="apiUrl" class="api-url">
                        API: Not connected
                    </div>
                </div>
                <div class="status-card">
                    <h3>Current Mode</h3>
                    <div id="processingMode" class="status-indicator status-processing">
                        Documentation
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation Mode Content -->
        <div id="documentationMode">
            <div class="content-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <book-open x="2" y="3" width="20" height="18" rx="2" ry="2"></book-open>
                        <path d="m6 8 4 4 4-4"></path>
                    </svg>
                    API Integration Guide
                </h2>

                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('overview')">Overview</button>
                        <button class="tab-button" onclick="showTab('endpoints')">API Endpoints</button>
                        <button class="tab-button" onclick="showTab('workflow')">Workflow</button>
                        <button class="tab-button" onclick="showTab('examples')">Code Examples</button>
                        <button class="tab-button" onclick="showTab('security')">Security</button>
                    </div>

                    <div id="overview" class="tab-content active">
                        <h3>Overview</h3>
                        <p class="overview-description">Automatically detects and formats Excel column headers using intelligent fuzzy matching to standardize business data formats.</p>

                        <div class="feature-grid">
                            <div class="feature-item">
                                <h4>Intelligent Header Detection</h4>
                                <p>Uses advanced algorithms to match column headers regardless of naming variations</p>
                            </div>
                            <div class="feature-item">
                                <h4>Smart Formatting</h4>
                                <p>Applies professional formatting with proper fonts, alignment, and data types</p>
                            </div>
                            <div class="feature-item">
                                <h4>Standardized Output</h4>
                                <p>Produces consistently formatted Excel files with standardized column names</p>
                            </div>
                            <div class="feature-item">
                                <h4>Data Validation</h4>
                                <p>Validates and formats dates, numbers, and text fields automatically</p>
                            </div>
                        </div>

                        <div class="required-columns">
                            <h4>Required Columns Detected</h4>
                            <div class="columns-grid">
                                <span class="column-tag">GroupName</span>
                                <span class="column-tag">CorpName</span>
                                <span class="column-tag">Amount_To_Apply</span>
                                <span class="column-tag">ReceiptType</span>
                                <span class="column-tag">ReceiptNumber</span>
                                <span class="column-tag">RecBatchName</span>
                                <span class="column-tag">ReceiptCreateDate</span>
                                <span class="column-tag">ReceiptsID</span>
                                <span class="column-tag">CorpID</span>
                                <span class="column-tag">GroupID</span>
                                <span class="column-tag">RecBatchID</span>
                                <span class="column-tag">PostDate</span>
                                <span class="column-tag">SourceName</span>
                                <span class="column-tag">Notes</span>
                                <span class="column-tag">Date Last Change</span>
                                <span class="column-tag">User Last Change</span>
                            </div>
                        </div>
                    </div>

                    <div id="endpoints" class="tab-content">
                        <h3>API Endpoints</h3>

                        <div class="endpoint-card">
                            <div class="endpoint-header">
                                <span class="method get">GET</span>
                                <span class="endpoint-path">/api/excel-formatter</span>
                            </div>
                            <p class="endpoint-description">Get service information and supported formats</p>

                            <h4>Response</h4>
                            <pre class="code-block"><code>{
  "service": "Excel Formatter API",
  "description": "Upload Excel files to automatically detect and format columns",
  "supported_formats": ["xlsx", "xls"],
  "required_columns": ["GroupName", "CorpName", "Amount_To_Apply", ...]
}</code></pre>
                        </div>

                        <div class="endpoint-card">
                            <div class="endpoint-header">
                                <span class="method post">POST</span>
                                <span class="endpoint-path">/api/excel-formatter/process</span>
                            </div>
                            <p class="endpoint-description">Upload and process Excel file for formatting</p>

                            <h4>Request</h4>
                            <pre class="code-block"><code>Content-Type: multipart/form-data

file: [Excel file (.xlsx/.xls)]</code></pre>

                            <h4>Response</h4>
                            <pre class="code-block"><code>{
  "success": true,
  "message": "Successfully processed Excel file with 12 columns",
  "columns_found": 12,
  "rows_processed": 150,
  "columns_matched": ["GroupName", "CorpName", "Amount_To_Apply", ...],
  "columns_missing": ["Notes"],
  "processing_log": {...},
  "download_ready": true
}</code></pre>
                        </div>

                        <div class="endpoint-card">
                            <div class="endpoint-header">
                                <span class="method post">POST</span>
                                <span class="endpoint-path">/api/excel-formatter/download</span>
                            </div>
                            <p class="endpoint-description">Download the formatted Excel file</p>

                            <h4>Request</h4>
                            <pre class="code-block"><code>Content-Type: application/json

{
  "file_path": "/path/to/formatted/file.xlsx"
}</code></pre>

                            <h4>Response</h4>
                            <pre class="code-block"><code>Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="formatted_excel_file.xlsx"

[Binary Excel file data]</code></pre>
                        </div>
                    </div>

                    <div id="workflow" class="tab-content">
                        <h3>Integration Workflow</h3>

                        <div class="integration-steps">
                            <div class="integration-step">
                                <h4>Upload Excel File</h4>
                                <p>Send Excel file (.xlsx/.xls) via POST to <code>/api/excel-formatter/process</code></p>
                            </div>

                            <div class="integration-step">
                                <h4>Header Detection</h4>
                                <p>System analyzes first 100 rows to detect column headers using fuzzy matching</p>
                            </div>

                            <div class="integration-step">
                                <h4>Data Processing</h4>
                                <p>Formats dates, numbers, and applies professional styling to the Excel file</p>
                            </div>

                            <div class="integration-step">
                                <h4>Download Results</h4>
                                <p>Receive formatted Excel file with standardized headers and professional styling</p>
                            </div>
                        </div>
                    </div>

                    <div id="examples" class="tab-content">
                        <h3>Code Examples</h3>

                        <div class="example-section">
                            <h4>JavaScript/Fetch API</h4>
                            <pre class="code-block"><code>// Upload and process Excel file
const formData = new FormData();
formData.append('file', excelFile);

const response = await fetch('${API_BASE_URL}/api/excel-formatter/process', {
    method: 'POST',
    body: formData
});

const result = await response.json();
if (result.success) {
    console.log(`Processed ${result.columns_found} columns`);
    console.log('Matched columns:', result.columns_matched);
    console.log('Missing columns:', result.columns_missing);
}</code></pre>
                        </div>

                        <div class="example-section">
                            <h4>Python/Requests</h4>
                            <pre class="code-block"><code>import requests

# Upload Excel file
with open('your_file.xlsx', 'rb') as f:
    files = {'file': f}
    response = requests.post(
        'http://api-url/api/excel-formatter/process',
        files=files
    )

result = response.json()
if result['success']:
    print(f"Processed {result['columns_found']} columns")
    print(f"Matched: {result['columns_matched']}")
    print(f"Missing: {result['columns_missing']}")</code></pre>
                        </div>

                        <div class="example-section">
                            <h4>cURL</h4>
                            <pre class="code-block"><code># Upload Excel file for processing
curl -X POST \
  http://api-url/api/excel-formatter/process \
  -H 'Content-Type: multipart/form-data' \
  -F 'file=@your_file.xlsx'</code></pre>
                        </div>
                    </div>

                    <div id="security" class="tab-content">
                        <h3>Security & Best Practices</h3>

                        <div class="security-grid">
                            <div class="security-item">
                                <h4>File Validation</h4>
                                <p>Only .xlsx and .xls files are accepted. All uploads are validated for file type and structure.</p>
                            </div>
                            <div class="security-item">
                                <h4>Temporary Storage</h4>
                                <p>Files are processed in secure temporary directories and automatically cleaned up.</p>
                            </div>
                            <div class="security-item">
                                <h4>Data Processing</h4>
                                <p>No data is permanently stored. Processing happens in memory with immediate cleanup.</p>
                            </div>
                            <div class="security-item">
                                <h4>Error Handling</h4>
                                <p>Comprehensive error handling with detailed logging for debugging purposes.</p>
                            </div>
                        </div>

                        <div class="best-practices">
                            <h4>Best Practices</h4>
                            <ul>
                                <li>Ensure Excel files have headers in the first 100 rows</li>
                                <li>Use descriptive column names that match the required formats</li>
                                <li>Validate file size before upload (recommended max: 10MB)</li>
                                <li>Handle errors gracefully and check response status codes</li>
                                <li>Implement proper timeout handling for large files</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Testing Mode Content -->
        <div id="liveTestingMode" style="display: none;">
            <div class="content-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <upload x="14" y="2" width="8" height="5" rx="1"></upload>
                        <path d="M14,2 14,8 20,8"></path>
                        <circle cx="8" cy="18" r="4"></circle>
                        <path d="M16,18 12,14 6,20"></path>
                    </svg>
                    Live Excel Formatter Testing
                </h2>

                <div class="upload-section">
                    <div class="upload-card">
                        <h3>Upload Excel File</h3>
                        <p>Upload an Excel file (.xlsx/.xls) to automatically detect and format column headers</p>

                        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <path d="M8 12h8"></path>
                                    <path d="M12 8v8"></path>
                                </svg>
                            </div>
                            <p class="upload-text">Click to upload Excel file or drag and drop</p>
                            <p class="upload-subtext">Supports .xlsx and .xls files</p>
                        </div>

                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">

                        <div class="upload-controls" style="display: none;" id="uploadControls">
                            <button class="btn-primary" onclick="processFile()" id="processBtn">
                                <span class="btn-text">Format Excel File</span>
                                <span class="btn-loading" style="display: none;">
                                    <svg class="spinner" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="32" stroke-dashoffset="32">
                                            <animate attributeName="stroke-dasharray" dur="2s" values="0 32;16 16;0 32;0 32" repeatCount="indefinite"/>
                                            <animate attributeName="stroke-dashoffset" dur="2s" values="0;-16;-32;-32" repeatCount="indefinite"/>
                                        </circle>
                                    </svg>
                                    Processing...
                                </span>
                            </button>
                            <button class="btn-secondary" onclick="clearFile()" id="clearBtn">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-card">
                        <h3>Processing Results</h3>
                        <div id="resultsContent"></div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section" id="downloadSection" style="display: none;">
                    <div class="download-card">
                        <h3>Download Formatted File</h3>
                        <p>Your Excel file has been successfully formatted with standardized headers and professional styling.</p>
                        <button class="btn-success" onclick="downloadFile()" id="downloadBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Download Formatted Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global API configuration
        window.API_BASE_URL = '{{ api_url }}';
        let selectedFile = null;
        let processedFileId = null;

        // Mobile navigation toggle
        function toggleMobileNav() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('open');
        }

        // Mode toggle functionality
        function toggleMode() {
            const toggle = document.getElementById('modeToggle');
            const docMode = document.getElementById('documentationMode');
            const liveMode = document.getElementById('liveTestingMode');
            const modeIndicator = document.getElementById('processingMode');

            toggle.classList.toggle('active');

            if (toggle.classList.contains('active')) {
                docMode.style.display = 'none';
                liveMode.style.display = 'block';
                modeIndicator.textContent = 'Live Testing';
                modeIndicator.className = 'status-indicator status-connected';
            } else {
                docMode.style.display = 'block';
                liveMode.style.display = 'none';
                modeIndicator.textContent = 'Documentation';
                modeIndicator.className = 'status-indicator status-processing';
            }
        }

        // Tab functionality for documentation mode
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            // Show selected tab content and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // API status checker
        async function checkAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            const urlElement = document.getElementById('apiUrl');

            try {
                const response = await fetch(`${window.API_BASE_URL}/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    statusElement.textContent = 'Connected';
                    statusElement.className = 'status-indicator status-connected';
                    urlElement.textContent = `API: ${window.API_BASE_URL}`;
                } else {
                    throw new Error('API not healthy');
                }
            } catch (error) {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'status-indicator status-disconnected';
                urlElement.textContent = `API: ${window.API_BASE_URL} (offline)`;
            }
        }

        // File handling functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;

                // Update upload area
                const uploadArea = document.getElementById('fileUploadArea');
                uploadArea.innerHTML = `
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <path d="M9 12l2 2 4-4"></path>
                        </svg>
                    </div>
                    <p class="upload-text">File selected: ${file.name}</p>
                    <p class="upload-subtext">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;

                // Show controls
                document.getElementById('uploadControls').style.display = 'block';

                // Hide previous results
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('downloadSection').style.display = 'none';
            }
        }

        function clearFile() {
            selectedFile = null;
            processedFileId = null;
            document.getElementById('fileInput').value = '';

            // Reset upload area
            const uploadArea = document.getElementById('fileUploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <path d="M8 12h8"></path>
                        <path d="M12 8v8"></path>
                    </svg>
                </div>
                <p class="upload-text">Click to upload Excel file or drag and drop</p>
                <p class="upload-subtext">Supports .xlsx and .xls files</p>
            `;

            // Hide controls and results
            document.getElementById('uploadControls').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
        }

        async function processFile() {
            if (!selectedFile) return;

            const processBtn = document.getElementById('processBtn');
            const btnText = processBtn.querySelector('.btn-text');
            const btnLoading = processBtn.querySelector('.btn-loading');

            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            processBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const response = await fetch(`${window.API_BASE_URL}/api/excel-formatter/process`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Show results
                    showResults(result);
                    processedFileId = result.file_id; // Store file ID for download
                } else {
                    showError(result.error);
                }

            } catch (error) {
                showError(`Processing failed: ${error.message}`);
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                processBtn.disabled = false;
            }
        }

        function showResults(result) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="result-summary">
                    <div class="summary-item">
                        <span class="summary-label">Columns Found:</span>
                        <span class="summary-value success">${result.columns_found}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Rows Processed:</span>
                        <span class="summary-value success">${result.rows_processed}</span>
                    </div>
                </div>

                <div class="columns-status">
                    <h4>Matched Columns</h4>
                    <div class="columns-grid">
                        ${result.columns_matched.map(col => `<span class="column-tag success">${col}</span>`).join('')}
                    </div>

                    ${result.columns_missing && result.columns_missing.length > 0 ? `
                        <h4>Missing Columns</h4>
                        <div class="columns-grid">
                            ${result.columns_missing.map(col => `<span class="column-tag warning">${col}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            resultsSection.style.display = 'block';

            // Show download section if processing was successful
            if (result.success) {
                document.getElementById('downloadSection').style.display = 'block';
            }
        }

        function showError(errorMessage) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="error-message">
                    <h4>Processing Error</h4>
                    <p>${errorMessage}</p>
                </div>
            `;

            resultsSection.style.display = 'block';
        }

        function downloadFile() {
            if (!processedFileId) {
                alert('No file available for download. Please process a file first.');
                return;
            }

            // Create download URL using the file ID
            const downloadUrl = `${window.API_BASE_URL}/api/excel-formatter/download/${processedFileId}`;

            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = 'formatted_excel_file.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
            setInterval(checkAPIStatus, 30000);

            // Close mobile nav when clicking outside
            document.addEventListener('click', function(event) {
                const navLinks = document.querySelector('.nav-links');
                const toggle = document.querySelector('.mobile-nav-toggle');

                if (!navLinks.contains(event.target) && !toggle.contains(event.target)) {
                    navLinks.classList.remove('open');
                }
            });

            // Drag and drop functionality
            const uploadArea = document.getElementById('fileUploadArea');

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        document.getElementById('fileInput').files = files;
                        handleFileSelect({ target: { files: files } });
                    } else {
                        alert('Please upload an Excel file (.xlsx or .xls)');
                    }
                }
            });
        });
    </script>
</body>
</html>