<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Statement Processor - Integration Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .memory-testing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }
        .test-section {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 16px;
        }
        .test-section h3 {
            margin: 0 0 8px 0;
            color: #ffffff;
            font-size: 16px;
        }
        .test-section p {
            margin: 0 0 12px 0;
            color: rgba(255,255,255,0.85);
            font-size: 13px;
            font-weight: 400;
        }
        .test-input {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
        }
        .test-input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        .live-test-result {
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">AlaeAutomates <span style="font-size: 0.8em; opacity: 0.7; font-weight: 300;">API</span></a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/monthly-statements" class="nav-link active">Monthly Statements</a>
                <a href="/invoice-separator" class="nav-link">Invoice Separator</a>
                <a href="/credit-card-batch" class="nav-link">Credit Card Batch</a>
                <a href="/excel-formatter" class="nav-link">Excel Formatter</a>
                <a href="/excel-comparison" class="nav-link">Excel Comparison</a>
            </div>
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()" aria-label="Toggle navigation">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Monthly Statement Processor</h1>
            <p class="page-subtitle">Professional Integration Hub for PDF Statement Processing</p>
            
            <div class="mode-toggle">
                <span class="mode-label" id="simLabel">Documentation</span>
                <div class="toggle-switch" id="modeToggle" onclick="toggleMode()" role="button" tabindex="0" aria-label="Toggle between documentation and live testing mode" onkeydown="if(event.key==='Enter'||event.key===' '){toggleMode()}">
                    <div class="toggle-slider"></div>
                </div>
                <span class="mode-label" id="realLabel">Live Testing</span>
            </div>
        </div>
        
        <!-- Status Section -->
        <div class="content-section">
            <h2 class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
                System Status
            </h2>
            
            <div class="status-grid">
                <div class="status-card">
                    <h3>API Status</h3>
                    <div id="apiStatus" class="status-indicator status-disconnected">
                        Disconnected
                    </div>
                    <div id="apiUrl" class="api-url">
                        API: Not connected
                    </div>
                </div>
                <div class="status-card">
                    <h3>Current Mode</h3>
                    <div id="processingMode" class="status-indicator status-processing">
                        Documentation
                    </div>
                </div>
            </div>
        </div>

        <!-- Documentation Mode Content -->
        <div id="documentationMode">
            <div class="content-section">
                <h2 class="section-title">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <book-open x="2" y="3" width="20" height="18" rx="2" ry="2"></book-open>
                        <path d="m6 8 4 4 4-4"></path>
                    </svg>
                    API Integration Guide
                </h2>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('overview')">Overview</button>
                        <button class="tab-button" onclick="showTab('endpoints')">API Endpoints</button>
                        <button class="tab-button" onclick="showTab('workflow')">Workflow</button>
                        <button class="tab-button" onclick="showTab('examples')">Code Examples</button>
                        <button class="tab-button" onclick="showTab('memory')">Company Memory</button>
                        <button class="tab-button" onclick="showTab('security')">Security</button>
                    </div>

                    <div id="overview" class="tab-content active">
                        <h3>Overview</h3>
                        <p class="overview-description">Processes financial PDF statements and categorizes them using an Excel DNM (Do Not Mail) list.</p>
                        
                        <div class="feature-grid">
                            <div class="feature-item">
                                <h4>PDF Processing</h4>
                                <p>Extracts company information from PDF statements</p>
                            </div>
                            <div class="feature-item">
                                <h4>Smart Matching</h4>
                                <p>Fuzzy matches companies against your DNM list</p>
                            </div>
                            <div class="feature-item">
                                <h4>Manual Review</h4>
                                <p>Prompts for review when similarity is unclear</p>
                            </div>
                            <div class="feature-item">
                                <h4>Auto Categorization</h4>
                                <p>Sorts into DNM, Foreign, National Single/Multi</p>
                            </div>
                        </div>

                        <div class="security-note">
                            <strong>Performance:</strong> Optimized for large files with linear time complexity. Railway deployment ready.
                        </div>

                        <h3>Processing Flow</h3>
                        <div class="integration-steps">
                            <div class="integration-step">
                                <h4>Create Session</h4>
                                <p>Initialize a processing session to track your workflow</p>
                            </div>
                            <div class="integration-step">
                                <h4>Upload Files</h4>
                                <p>Upload PDF statement and Excel DNM list</p>
                            </div>
                            <div class="integration-step">
                                <h4>Process Statements</h4>
                                <p>API extracts and analyzes company information</p>
                            </div>
                            <div class="integration-step">
                                <h4>Manual Review (if needed)</h4>
                                <p>Answer questions about uncertain company matches</p>
                            </div>
                            <div class="integration-step">
                                <h4>Download Results</h4>
                                <p>Get ZIP file with split PDFs and JSON results</p>
                            </div>
                        </div>
                    </div>

                    <div id="endpoints" class="tab-content">
                        <h3>API Endpoints</h3>
                        
                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/health</strong>
                            <p>Check API health and status</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "healthy",
  "service": "statement-processor",
  "sessions": 0
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/statement-processor</strong>
                            <p>Create a new processing session</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "session_id": "uuid-here",
  "expires_in": 7200
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/statement-processor/{id}/upload</strong>
                            <p>Upload PDF and Excel files</p>
                            <div class="code-block" data-lang="FormData">
FormData:
- pdf: File (PDF statement)
- excel: File (Excel DNM list)</div>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Files uploaded successfully",
  "files": {
    "pdf": {"name": "statements.pdf", "size": 1048576},
    "excel": {"name": "dnm_list.xlsx", "size": 65536}
  }
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/statement-processor/{id}/process</strong>
                            <p>Start processing uploaded files</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Processing completed",
  "total_statements": 25,
  "questions_needed": 3
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/statement-processor/{id}/questions</strong>
                            <p>Get manual review questions (if any)</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "questions": [
    {
      "id": "question-uuid",
      "company_name": "ABC Corp Inc",
      "similar_to": "ABC Corporation",
      "percentage": "85.5%",
      "current_destination": "Natio Single",
      "first_page_number": 12,
      "all_matches": [
        {"company_name": "ABC Corporation", "percentage": "85.5%"},
        {"company_name": "ABC Industries Inc", "percentage": "72.3%"},
        {"company_name": "ABC Holdings LLC", "percentage": "68.9%"}
      ]
    }
  ],
  "total_statements": 25
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/statement-processor/{id}/answers</strong>
                            <p>Submit manual review answers</p>
                            <div class="code-block" data-lang="Request">
{
  "answers": {
    "ABC Corp Inc": "yes",
    "XYZ Company": "no"
  }
}</div>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Answers submitted successfully"
}</div>
                        </div>

                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/statement-processor/{id}/download</strong>
                            <p>Download processed results as ZIP file</p>
                            <div class="code-block" data-lang="Response">
Content-Type: application/zip
Content-Disposition: attachment; filename=monthlysttmnt{mm}{yyyy}.zip

Structure:
├── DNM.pdf (companies in DNM list)
├── Foreign.pdf (foreign companies)  
├── natioSingle.pdf (single-page national)
├── natioMulti.pdf (multi-page national)
└── logs/
    ├── processing_results.json (API data)
    └── processing_results.txt (detailed report)</div>
                        </div>
                    </div>

                    <div id="workflow" class="tab-content">
                        <h3>Integration Workflow</h3>
                        
                        <div class="code-block" data-lang="JavaScript">
// Complete workflow example
class StatementProcessor {
  constructor(apiUrl) {
    this.apiUrl = apiUrl;
    this.sessionId = null;
  }

  async processStatements(pdfFile, excelFile) {
    try {
      // 1. Create session
      const sessionResponse = await fetch(`${this.apiUrl}/api/statement-processor`, {
        method: 'POST',
        mode: 'cors'
      });
      const sessionData = await sessionResponse.json();
      this.sessionId = sessionData.session_id;

      // 2. Upload files
      const formData = new FormData();
      formData.append('pdf', pdfFile);
      formData.append('excel', excelFile);

      await fetch(`${this.apiUrl}/api/statement-processor/${this.sessionId}/upload`, {
        method: 'POST',
        mode: 'cors',
        body: formData
      });

      // 3. Start processing
      const processResponse = await fetch(`${this.apiUrl}/api/statement-processor/${this.sessionId}/process`, {
        method: 'POST',
        mode: 'cors'
      });
      const processData = await processResponse.json();

      // 4. Check for manual review questions
      if (processData.questions_needed > 0) {
        const questionsResponse = await fetch(`${this.apiUrl}/api/statement-processor/${this.sessionId}/questions`);
        const questionsData = await questionsResponse.json();
        
        // Show questions to user and get answers
        const answers = await this.showQuestionsToUser(questionsData.questions);
        
        // Submit answers
        await fetch(`${this.apiUrl}/api/statement-processor/${this.sessionId}/answers`, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers })
        });
      }

      // 5. Download results
      window.open(`${this.apiUrl}/api/statement-processor/${this.sessionId}/download`);
      
    } catch (error) {
      console.error('Processing failed:', error);
    }
  }

  async showQuestionsToUser(questions) {
    // Implement your UI for manual review
    const answers = {};
    for (const question of questions) {
      const answer = confirm(`Is "${question.company_name}" the same as "${question.similar_to}"?`);
      answers[question.company_name] = answer ? 'yes' : 'no';
    }
    return answers;
  }
}</div>

                        <h3>Frontend Integration Tips</h3>
                        <div class="tip-grid">
                            <div class="tip-item">
                                <strong>CORS Support</strong>
                                <p>API includes CORS headers for browser requests</p>
                            </div>
                            <div class="tip-item">
                                <strong>File Uploads</strong>
                                <p>Use FormData for multipart file uploads</p>
                            </div>
                            <div class="tip-item">
                                <strong>Error Handling</strong>
                                <p>Check response.ok before processing JSON</p>
                            </div>
                            <div class="tip-item">
                                <strong>Session Management</strong>
                                <p>Store session_id for workflow duration</p>
                            </div>
                        </div>
                    </div>

                    <div id="examples" class="tab-content">
                        <h3>React Integration Example</h3>
                        <div class="code-block" data-lang="React">
import React, { useState } from 'react';

function StatementProcessor() {
  const [sessionId, setSessionId] = useState(null);
  const [processing, setProcessing] = useState(false);
  const [questions, setQuestions] = useState([]);

  const processFiles = async (pdfFile, excelFile) => {
    setProcessing(true);
    
    try {
      // Create session
      const sessionRes = await fetch('/api/statement-processor', { method: 'POST' });
      const session = await sessionRes.json();
      setSessionId(session.session_id);

      // Upload files
      const formData = new FormData();
      formData.append('pdf', pdfFile);
      formData.append('excel', excelFile);
      
      await fetch(`/api/statement-processor/${session.session_id}/upload`, {
        method: 'POST',
        body: formData
      });

      // Process
      const processRes = await fetch(`/api/statement-processor/${session.session_id}/process`, {
        method: 'POST'
      });
      const processData = await processRes.json();

      if (processData.questions_needed > 0) {
        const questionsRes = await fetch(`/api/statement-processor/${session.session_id}/questions`);
        const questionsData = await questionsRes.json();
        setQuestions(questionsData.questions);
      } else {
        downloadResults(session.session_id);
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setProcessing(false);
    }
  };

  const submitAnswers = async (answers) => {
    await fetch(`/api/statement-processor/${sessionId}/answers`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answers })
    });
    downloadResults(sessionId);
  };

  const downloadResults = (sessionId) => {
    window.open(`/api/statement-processor/${sessionId}/download`);
  };

  return (
    <div>
      {/* Your UI components here */}
    </div>
  );
}</div>

                        <h3>Python Integration Example</h3>
                        <div class="code-block" data-lang="Python">
import requests

class StatementProcessorClient:
    def __init__(self, api_url):
        self.api_url = api_url
        self.session_id = None

    def process_statements(self, pdf_path, excel_path):
        # Create session
        session_response = requests.post(f"{self.api_url}/api/statement-processor")
        session_data = session_response.json()
        self.session_id = session_data['session_id']

        # Upload files
        with open(pdf_path, 'rb') as pdf_file, open(excel_path, 'rb') as excel_file:
            files = {
                'pdf': pdf_file,
                'excel': excel_file
            }
            upload_response = requests.post(
                f"{self.api_url}/api/statement-processor/{self.session_id}/upload",
                files=files
            )

        # Process
        process_response = requests.post(
            f"{self.api_url}/api/statement-processor/{self.session_id}/process"
        )
        process_data = process_response.json()

        # Handle questions if needed
        if process_data.get('questions_needed', 0) > 0:
            questions_response = requests.get(
                f"{self.api_url}/api/statement-processor/{self.session_id}/questions"
            )
            questions = questions_response.json()['questions']
            
            # Get user answers (implement your logic)
            answers = self.get_user_answers(questions)
            
            # Submit answers
            requests.post(
                f"{self.api_url}/api/statement-processor/{self.session_id}/answers",
                json={'answers': answers}
            )

        # Download results
        download_response = requests.get(
            f"{self.api_url}/api/statement-processor/{self.session_id}/download"
        )
        
        with open('results.zip', 'wb') as f:
            f.write(download_response.content)

    def get_user_answers(self, questions):
        # Implement your question handling logic
        answers = {}
        for question in questions:
            user_input = input(f"Is '{question['company_name']}' the same as '{question['similar_to']}'? (y/n): ")
            answers[question['company_name']] = 'yes' if user_input.lower() == 'y' else 'no'
        return answers</div>
                    </div>

                    <div id="memory" class="tab-content">
                        <h3>Company Memory System</h3>
                        <p class="overview-description">Stores company matching decisions permanently. Once you decide if two companies are the same or different, the system remembers and applies the decision automatically in future processing.</p>

                        <div class="memory-status-section">
                            <h4>Memory System Status</h4>
                            <div class="status-grid">
                                <div class="status-card">
                                    <h5>System Health</h5>
                                    <div id="memorySystemStatus" class="status-indicator status-disconnected">Checking...</div>
                                </div>
                                <div class="status-card">
                                    <h5>Stored Companies</h5>
                                    <div id="memoryCompaniesCount" class="status-indicator">Loading...</div>
                                </div>
                                <div class="status-card">
                                    <h5>Total Decisions</h5>
                                    <div id="memoryDecisionsCount" class="status-indicator">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <h4>Memory API Endpoints</h4>
                        
                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/company-memory/stats</strong>
                            <p>Get memory system statistics</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "total_companies": 504,
  "total_questions": 1396,
  "total_matches": 627,
  "avg_similarity": 56.5,
  "system_initialized": "2025-09-09 03:03:04"
}</div>
                        </div>
                        
                        <div class="endpoint-card">
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/api/company-memory/companies</strong>
                            <p>Retrieve all stored companies and decisions</p>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "companies": [
    {
      "extracted_company": "Microsoft Corp",
      "avg_similarity": 82.5,
      "confirmed_matches": 2,
      "equivalences": [
        {
          "dnm_company": "Microsoft Corporation",
          "user_decision": true,
          "similarity_percentage": 85.0
        }
      ]
    }
  ]
}</div>
                        </div>
                        
                        <div class="endpoint-card">
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/api/company-memory/store</strong>
                            <p>Store new company matching decision</p>
                            <div class="code-block" data-lang="Request">
{
  "extracted_company": "Apple Inc",
  "dnm_company": "Apple Corporation",
  "user_decision": true,
  "similarity_percentage": 78.5
}</div>
                            <div class="code-block" data-lang="Response">
{
  "status": "success",
  "message": "Decision stored successfully"
}</div>
                        </div>

                        <h4>Automatic Integration (Recommended)</h4>
                        <div class="code-block" data-lang="JavaScript">
// Memory system works automatically with existing code!
// No changes needed - just upload and process as usual

const formData = new FormData();
formData.append('file', pdfFile);

// Upload file (same as before)
const response = await fetch('{{ api_url }}/api/statement-processor', {
    method: 'POST',
    body: formData
});

const result = await response.json();
// Memory decisions automatically applied!
// Only companies without stored decisions will need review

// Submit answers (automatically stored in memory for future use)
if (result.companies_requiring_review.length > 0) {
    const answers = await getUserAnswers(result.companies_requiring_review);
    
    await fetch(`{{ api_url }}/api/statement-processor/${result.session_id}/answers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers })
    });
    // All answers automatically stored in memory!
}
                        </div>

                        <h4>Memory Statistics Check</h4>
                        <div class="code-block" data-lang="JavaScript">
// Check memory system performance
const stats = await fetch('{{ api_url }}/api/company-memory/stats')
    .then(r => r.json());

console.log('Memory System Stats:');
console.log(`Companies stored: ${stats.total_companies}`);
console.log(`Decisions made: ${stats.total_questions}`);
console.log(`Confirmed matches: ${stats.total_matches}`);
console.log(`Average similarity: ${stats.avg_similarity.toFixed(1)}%`);
                        </div>

                        <h4>Manual Decision Storage</h4>
                        <div class="code-block" data-lang="JavaScript">
// Store decision manually (optional - usually automatic)
const decision = {
    extracted_company: 'Microsoft Corp',
    dnm_company: 'Microsoft Corporation',
    user_decision: true,  // true = same company, false = different
    similarity_percentage: 85.5,
    session_id: 'optional-session-id'
};

const response = await fetch('{{ api_url }}/api/company-memory/store', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(decision)
});

const result = await response.json();
console.log('Decision stored:', result.status);  // "success"
                        </div>


                        <div class="memory-testing-section">
                            <h4>Test Memory System</h4>
                            <button onclick="testMemorySystem()" class="button secondary">Check Memory Stats</button>
                            <button onclick="testCompaniesEndpoint()" class="button secondary">List Companies</button>
                            <div id="memoryTestResults" class="test-results"></div>
                        </div>
                    </div>

                    <div id="security" class="tab-content">
                        <h3>Security & Best Practices</h3>
                        
                        <div class="security-note">
                            <strong>Security Features:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>File type validation (PDF, Excel only)</li>
                                <li>File size limits (50MB maximum)</li>
                                <li>Session-based processing with automatic cleanup</li>
                                <li>Request timeout protection (5 minutes)</li>
                                <li>Secure filename handling</li>
                                <li>CORS configuration for browser security</li>
                            </ul>
                        </div>

                        <h3>Integration Checklist</h3>
                        <div class="integration-steps">
                            <div class="integration-step">
                                <h4>File Validation</h4>
                                <p>Validate file types and sizes before upload</p>
                                <div class="code-block" data-lang="JavaScript">
// Client-side validation
function validateFiles(pdfFile, excelFile) {
  if (!pdfFile || !pdfFile.name.toLowerCase().endsWith('.pdf')) {
    throw new Error('Invalid PDF file');
  }
  if (!excelFile || !excelFile.name.toLowerCase().match(/\.(xlsx?|xls)$/)) {
    throw new Error('Invalid Excel file');
  }
  if (pdfFile.size > 50 * 1024 * 1024) {
    throw new Error('PDF file too large (max 50MB)');
  }
}</div>
                            </div>
                            
                            <div class="integration-step">
                                <h4>Error Handling</h4>
                                <p>Implement comprehensive error handling</p>
                                <div class="code-block" data-lang="JavaScript">
// Error handling example
async function apiCall(url, options) {
  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    // Show user-friendly error message
    showErrorMessage('Processing failed. Please try again.');
    throw error;
  }
}</div>
                            </div>
                            
                            <div class="integration-step">
                                <h4>Session Management</h4>
                                <p>Handle session lifecycle properly</p>
                                <div class="code-block" data-lang="JavaScript">
// Session cleanup
class SessionManager {
  constructor(apiUrl) {
    this.apiUrl = apiUrl;
    this.sessions = new Set();
  }

  async createSession() {
    const response = await fetch(`${this.apiUrl}/api/statement-processor`, { method: 'POST' });
    const data = await response.json();
    this.sessions.add(data.session_id);
    return data.session_id;
  }

  async cleanupSession(sessionId) {
    try {
      await fetch(`${this.apiUrl}/api/statement-processor/${sessionId}`, { method: 'DELETE' });
      this.sessions.delete(sessionId);
    } catch (error) {
      console.warn('Session cleanup failed:', error);
    }
  }

  // Cleanup all sessions on page unload
  cleanupAllSessions() {
    this.sessions.forEach(sessionId => this.cleanupSession(sessionId));
  }
}</div>
                            </div>
                        </div>

                        <h3>Production Deployment</h3>
                        <div class="deployment-grid">
                            <div class="deployment-item">
                                <strong>Railway Optimized</strong>
                                <p>Designed for Railway deployment</p>
                            </div>
                            <div class="deployment-item">
                                <strong>Horizontally Scalable</strong>
                                <p>Stateless design for scaling</p>
                            </div>
                            <div class="deployment-item">
                                <strong>Health Monitoring</strong>
                                <p>Built-in health check endpoint</p>
                            </div>
                            <div class="deployment-item">
                                <strong>Performance</strong>
                                <p>O(n) complexity, memory efficient</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Testing Mode Content -->
        <div id="liveTestingMode" style="display: none;">
            <div class="card">
                <h2>Live API Testing</h2>
                <p>Test the API with real files and see actual responses</p>
                
                <div class="api-info">
                    <div>
                        <h3>Test with Your Files</h3>
                        <div class="file-upload" onclick="document.getElementById('pdfInput').click()" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){document.getElementById('pdfInput').click()}">
                            <div id="pdfStatus">Click to select PDF file</div>
                            <input type="file" id="pdfInput" accept=".pdf" style="display: none;" onchange="handleFileSelect('pdf', this)" aria-label="Select PDF file">
                        </div>
                        
                        <div class="file-upload" onclick="document.getElementById('excelInput').click()" style="margin-top: 15px;" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){document.getElementById('excelInput').click()}">
                            <div id="excelStatus">Click to select Excel file</div>
                            <input type="file" id="excelInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect('excel', this)" aria-label="Select Excel file">
                        </div>
                    </div>
                    <div>
                        <h3>Processing Progress</h3>
                        <div class="progress-bar" role="progressbar" aria-label="Processing progress">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div id="progressText" aria-live="polite">Ready to start...</div>
                        
                        <button class="button" id="startProcessing" onclick="startLiveProcessing()" disabled>
                            Start Processing
                        </button>
                        
                        <!-- Manual Review Button (hidden initially) -->
                        <button class="button warning manual-review-btn" id="manualReviewBtn" onclick="openManualReviewModal(event)" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                <path d="M12 9v4"/>
                                <path d="m12 17 .01 0"/>
                            </svg>
                            Manual Review Required
                        </button>
                    </div>
                </div>
            </div>

            <!-- Company Memory Live Testing -->
            <div class="card">
                <h2>Company Memory System Testing</h2>
                <p>Test memory system endpoints with live API calls</p>
                
                <div class="memory-testing-grid">
                    <div class="test-section">
                        <h3>Memory Statistics</h3>
                        <p>Get current memory system stats</p>
                        <div class="code-block" data-lang="Request">
GET {{ api_url }}/api/company-memory/stats</div>
                        <button onclick="liveTestMemoryStats()" class="button secondary">Test Stats Endpoint</button>
                        <div id="liveMemoryStatsResult" class="live-test-result"></div>
                    </div>
                    
                    <div class="test-section">
                        <h3>Companies List</h3>
                        <p>Retrieve all stored companies and decisions</p>
                        <div class="code-block" data-lang="Request">
GET {{ api_url }}/api/company-memory/companies</div>
                        <button onclick="liveTestCompaniesList()" class="button secondary">Test Companies Endpoint</button>
                        <div id="liveCompaniesResult" class="live-test-result"></div>
                    </div>
                    
                    <div class="test-section">
                        <h3>Store Decision</h3>
                        <p>Store a new company matching decision</p>
                        <input type="text" id="liveExtractedCompany" placeholder="Extracted Company" class="test-input">
                        <input type="text" id="liveDnmCompany" placeholder="DNM Company" class="test-input">
                        <select id="liveUserDecision" class="test-input">
                            <option value="true">Same Company (Yes)</option>
                            <option value="false">Different Company (No)</option>
                        </select>
                        <div class="code-block" data-lang="Request">
POST {{ api_url }}/api/company-memory/store
{
  "extracted_company": "[your input]",
  "dnm_company": "[your input]",
  "user_decision": true/false,
  "similarity_percentage": 85.5
}</div>
                        <button onclick="liveTestStoreDecision()" class="button secondary">Test Store Endpoint</button>
                        <div id="liveStoreResult" class="live-test-result"></div>
                    </div>
                </div>
            </div>

            <!-- Manual Review Modal -->
            <div class="modal-overlay" id="manualReviewModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Manual Review Required</h2>
                        <button class="modal-close" onclick="closeManualReviewModal(event)">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="questions-header">
                        <div>
                            <h3 style="margin: 0; color: #856404;">Manual Review Questions</h3>
                            <p style="margin: 5px 0 0 0; color: #856404;">Review company matches and confirm if they're the same entity</p>
                        </div>
                        <button class="button secondary" id="skipAllBtn" onclick="skipAllQuestions()">
                            Skip All
                        </button>
                    </div>
                    
                    <div class="questions-container" id="questionsList">
                        <!-- Questions will be populated here -->
                    </div>
                    
                    <div class="modal-footer">
                        <button class="button success" id="submitAnswers" onclick="submitManualAnswers()" disabled>
                            Submit Answers
                        </button>
                        <button class="button secondary" onclick="clearAllAnswers()">
                            Clear All
                        </button>
                        <button class="button" onclick="closeManualReviewModal(event)">
                            Close
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>API Responses</h2>
                <div id="responseContainer">
                    <p>Start processing to see API responses...</p>
                </div>
            </div>

            <div class="card">
                <h2>Activity Log</h2>
                <div class="log-container" id="liveLogContainer" role="log" aria-label="Activity log" aria-live="polite"></div>
                <button class="button secondary" onclick="clearLiveLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isLiveMode = false;
        let currentSessionId = null;
        let selectedFiles = { pdf: null, excel: null };
        let userAnswers = {};
        let currentWorkflowStep = 'pdf_input'; // Track current workflow step
        let workflowSteps = ['pdf_input', 'excel_input', 'process', 'manual_review', 'download'];
        
        // API Configuration
        window.API_BASE_URL = '{{ api_url }}';
        
        // Enhanced logging function
        function detailedLog(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`, data || '');
            liveLog(message, type, data);
        }

        // Mode toggle functionality
        function toggleMode() {
            isLiveMode = !isLiveMode;
            const toggle = document.getElementById('modeToggle');
            const simLabel = document.getElementById('simLabel');
            const realLabel = document.getElementById('realLabel');
            const docMode = document.getElementById('documentationMode');
            const liveMode = document.getElementById('liveTestingMode');
            const processingMode = document.getElementById('processingMode');
            const apiStatus = document.getElementById('apiStatus');
            const apiUrl = document.getElementById('apiUrl');

            if (isLiveMode) {
                toggle.classList.add('active');
                simLabel.classList.remove('active');
                realLabel.classList.add('active');
                docMode.style.display = 'none';
                liveMode.style.display = 'block';
                processingMode.innerHTML = 'Live Testing';
                processingMode.className = 'status-indicator status-processing';
                testAPIConnection();
                // Start workflow heartbeat when entering live mode
                updateWorkflowHeartbeat();
            } else {
                toggle.classList.remove('active');
                simLabel.classList.add('active');
                realLabel.classList.remove('active');
                docMode.style.display = 'block';
                liveMode.style.display = 'none';
                processingMode.innerHTML = 'Documentation';
                processingMode.className = 'status-indicator status-processing';
                // Reset API status when switching to documentation mode
                apiStatus.innerHTML = 'Disconnected';
                apiStatus.className = 'status-indicator status-disconnected';
                apiUrl.innerHTML = 'API: Not connected';
            }
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the correct button (safer approach)
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                if (button.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    button.classList.add('active');
                }
            });
        }

        // API connection test
        async function testAPIConnection() {
            const apiStatus = document.getElementById('apiStatus');
            const apiUrl = document.getElementById('apiUrl');
            
            detailedLog(`Testing API connection to ${window.API_BASE_URL}`, 'info');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                if (response.ok) {
                    const data = await response.json();
                    apiStatus.innerHTML = 'Connected';
                    apiStatus.className = 'status-indicator status-connected';
                    apiUrl.innerHTML = `API: ${window.API_BASE_URL}`;
                    
                    detailedLog('Connected to processing API', 'success', data);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                apiStatus.innerHTML = 'Connection Failed';
                apiStatus.className = 'status-indicator status-disconnected';
                apiUrl.innerHTML = `API: ${window.API_BASE_URL} (FAILED)`;
                detailedLog(`API connection failed: ${error.message}`, 'error');
            }
        }

        // Live logging
        function liveLog(message, type = 'info') {
            const logContainer = document.getElementById('liveLogContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLiveLog() {
            document.getElementById('liveLogContainer').innerHTML = '';
            liveLog('Log cleared', 'info');
        }

        // File handling
        function handleFileSelect(type, input) {
            const file = input.files[0];
            if (file) {
                selectedFiles[type] = file;
                const statusElement = document.getElementById(`${type}Status`);
                const fileType = type === 'pdf' ? 'PDF' : 'Excel';
                statusElement.innerHTML = `${fileType}: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
                liveLog(`Selected ${type.toUpperCase()}: ${file.name}`, 'info');
                
                // Advance workflow based on file type
                if (type === 'pdf') {
                    advanceWorkflowStep('excel_input');
                } else if (type === 'excel' && selectedFiles.pdf) {
                    advanceWorkflowStep('process');
                }
                
                // Enable start button if both files selected
                if (selectedFiles.pdf && selectedFiles.excel) {
                    document.getElementById('startProcessing').disabled = false;
                }
            }
        }

        // Update progress
        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percent}%`;
            progressText.textContent = message;
            
            liveLog(`Progress: ${percent}% - ${message}`, 'info');
        }

        // Show API response
        function showAPIResponse(title, data, endpoint) {
            const container = document.getElementById('responseContainer');
            
            const responseDiv = document.createElement('div');
            responseDiv.className = 'response-viewer';
            
            // Format JSON with proper indentation and syntax highlighting
            const formattedJson = formatJSON(data);
            
            responseDiv.innerHTML = `
                <div class="response-header">${title}</div>
                <div style="margin-bottom: 10px;">
                    <strong>Endpoint:</strong> <code>${endpoint}</code>
                </div>
                <pre class="json-viewer"><code>${formattedJson}</code></pre>
            `;
            
            container.appendChild(responseDiv);
            
            // Don't auto-scroll for API responses - let user control scrolling
        }
        
        // Format JSON with syntax highlighting
        function formatJSON(obj) {
            const jsonString = JSON.stringify(obj, null, 2);
            return jsonString
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: null/g, ': <span class="json-null">null</span>');
        }

        // Main processing function
        async function startLiveProcessing() {
            try {
                updateProgress(0, 'Starting processing...');
                document.getElementById('startProcessing').disabled = true;
                
                // 1. Create session
                updateProgress(10, 'Creating session...');
                const sessionResponse = await fetch(`${window.API_BASE_URL}/api/statement-processor`, {
                    method: 'POST',
                    mode: 'cors'
                });
                const sessionData = await sessionResponse.json();
                
                if (sessionData.status !== 'success') {
                    throw new Error(`Session creation failed: ${sessionData.error || 'Unknown error'}`);
                }
                
                currentSessionId = sessionData.session_id;
                detailedLog(` Session created: ${currentSessionId}`, 'success', sessionData);
                showAPIResponse('Session Created', sessionData, 'POST /api/statement-processor');

                // 2. Upload files
                updateProgress(30, 'Uploading files...');
                const formData = new FormData();
                formData.append('pdf', selectedFiles.pdf);
                formData.append('excel', selectedFiles.excel);

                const uploadResponse = await fetch(`${window.API_BASE_URL}/api/statement-processor/${currentSessionId}/upload`, {
                    method: 'POST',
                    mode: 'cors',
                    body: formData
                });
                const uploadData = await uploadResponse.json();
                
                if (uploadData.status !== 'success') {
                    throw new Error(`File upload failed: ${uploadData.error || 'Unknown error'}`);
                }
                
                detailedLog(` Files uploaded successfully`, 'success', uploadData);
                showAPIResponse('Files Uploaded', uploadData, `POST /api/statement-processor/{id}/upload`);

                // 3. Process statements
                updateProgress(60, 'Processing statements...');
                const processResponse = await fetch(`${window.API_BASE_URL}/api/statement-processor/${currentSessionId}/process`, {
                    method: 'POST',
                    mode: 'cors'
                });
                const processData = await processResponse.json();
                
                showAPIResponse('Processing Results', processData, `POST /api/statement-processor/{id}/process`);
                liveLog(`Processing completed: ${processData.total_statements} statements, ${processData.questions_needed} questions`, 'success');
                
                // Processing insights available in API response

                // 4. Check for questions
                if (processData.questions_needed > 0) {
                    updateProgress(80, 'Getting manual review questions...');
                    const questionsResponse = await fetch(`${window.API_BASE_URL}/api/statement-processor/${currentSessionId}/questions`);
                    const questionsData = await questionsResponse.json();
                    
                    showAPIResponse('Manual Review Questions', questionsData, `GET /api/statement-processor/{id}/questions`);
                    showQuestions(questionsData.questions);
                    updateProgress(90, 'Manual review required - click button below to review');
                    advanceWorkflowStep('manual_review');
                } else {
                    updateProgress(100, 'Processing complete! Ready for download.');
                    enableDownload();
                    advanceWorkflowStep('download');
                }

            } catch (error) {
                liveLog(`Processing failed: ${error.message}`, 'error');
                updateProgress(0, 'Processing failed');
                document.getElementById('startProcessing').disabled = false;
            }
        }

        // Modal functions
        function openManualReviewModal(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const modal = document.getElementById('manualReviewModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            liveLog('Manual review modal opened', 'info');
        }
        
        function closeManualReviewModal(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const modal = document.getElementById('manualReviewModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            liveLog('Manual review modal closed', 'info');
        }
        
        // Show manual review button
        function showManualReviewButton() {
            const button = document.getElementById('manualReviewBtn');
            button.style.display = 'block';
            updateManualReviewButtonState();
        }
        
        // Update manual review button state
        function updateManualReviewButtonState() {
            const button = document.getElementById('manualReviewBtn');
            const totalQuestions = document.querySelectorAll('.question-item').length;
            const answeredCount = Object.keys(userAnswers).length;
            
            if (answeredCount >= totalQuestions && totalQuestions > 0) {
                button.classList.add('answered');
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4"/>
                        <circle cx="12" cy="12" r="10"/>
                    </svg>
                    Review Complete (Click to Edit)
                `;
            } else {
                button.classList.remove('answered');
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                        <path d="M12 9v4"/>
                        <path d="m12 17 .01 0"/>
                    </svg>
                    Manual Review Required (${answeredCount}/${totalQuestions})
                `;
            }
        }
        
        // Show manual review questions
        function showQuestions(questions) {
            const questionsList = document.getElementById('questionsList');
            
            questionsList.innerHTML = '';
            userAnswers = {};

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                // Escape quotes for onclick handlers
                const escapedCompanyName = question.company_name.replace(/'/g, "\\'");
                
                questionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0; color: #2c3e50;">Question ${index + 1} of ${questions.length}</h4>
                            <p style="margin: 5px 0 0 0; color: #667eea; font-size: 0.9rem; font-weight: 600;">Company found on page ${question.first_page_number || 'Unknown'}</p>
                        </div>
                        <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                            ${question.percentage} match
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>Found Company:</strong> <code>${question.company_name}</code></p>
                        <p style="margin: 8px 0;"><strong>Best Match:</strong> <code>${question.similar_to}</code></p>
                        <p style="margin: 8px 0;"><strong>Current Destination:</strong> <span style="background: #f8f9fa; padding: 2px 8px; border-radius: 4px;">${question.current_destination}</span></p>
                        
                        <!-- Show all potential matches -->
                        ${question.all_matches && question.all_matches.length > 1 ? `
                        <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                            <strong>All Potential Matches Found:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                ${question.all_matches.map((match, idx) => `
                                    <li style="margin: 4px 0; ${idx === 0 ? 'font-weight: bold; color: #667eea;' : ''}">
                                        ${match.company_name} <span style="font-weight: bold; color: #28a745;">(${match.percentage})</span>
                                        ${idx === 0 ? ' <em style="color: #667eea;">← Best Match</em>' : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong> Company "${question.company_name}" on page ${question.first_page_number || 'Unknown'} - is this the same as "${question.similar_to}"?</strong>
                        <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9rem;">If they're the same company, the document will be moved to the DNM list. Review all potential matches above before deciding.</p>
                    </div>
                    
                    <div class="question-buttons">
                        <button class="button success" onclick="setAnswer('${escapedCompanyName}', 'yes', ${index})">
                            Yes - Same Company
                        </button>
                        <button class="button danger" onclick="setAnswer('${escapedCompanyName}', 'no', ${index})">
                            No - Different
                        </button>
                        <button class="button secondary" onclick="setAnswer('${escapedCompanyName}', 'skip', ${index})">
                            Skip This One
                        </button>
                    </div>
                    
                    <div id="answer-${index}" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                `;
                questionsList.appendChild(questionDiv);
            });

            liveLog(`Showing ${questions.length} manual review questions in modal`, 'info');
            
            // Initialize submit button state
            updateSubmitButtonState();
            
            // Show the manual review button
            showManualReviewButton();
        }

        // Update submit button state based on answers
        function updateSubmitButtonState() {
            const submitButton = document.getElementById('submitAnswers');
            if (!submitButton) return;
            
            const answeredCount = Object.keys(userAnswers).length;
            const hasValidAnswers = answeredCount > 0;
            
            submitButton.disabled = !hasValidAnswers;
            
            if (hasValidAnswers) {
                submitButton.style.opacity = '1';
                submitButton.style.cursor = 'pointer';
                submitButton.style.background = 'var(--success)';
                submitButton.title = `Submit ${answeredCount} answer(s)`;
            } else {
                submitButton.style.opacity = '0.5';
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.background = 'var(--primary-300)';
                submitButton.title = 'Please answer at least one question';
            }
        }
        
        // Set answer for a question
        function setAnswer(companyName, answer, questionIndex) {
            userAnswers[companyName] = answer;
            
            const answerDiv = document.getElementById(`answer-${questionIndex}`);
            const answerText = answer === 'yes' ? 'Same Company - Will move to DNM list' : 
                             answer === 'no' ? 'Different Company - Will keep current destination' : 
                             'Skipped - Will use default categorization';
            
            const bgColor = answer === 'yes' ? '#d4edda' : answer === 'no' ? '#f8d7da' : '#e2e3e5';
            const textColor = answer === 'yes' ? '#155724' : answer === 'no' ? '#721c24' : '#383d41';
            
            answerDiv.style.display = 'block';
            answerDiv.style.background = bgColor;
            answerDiv.style.color = textColor;
            answerDiv.style.border = `1px solid ${answer === 'yes' ? '#c3e6cb' : answer === 'no' ? '#f5c6cb' : '#d1d3d4'}`;
            answerDiv.innerHTML = `<strong>${answerText}</strong>`;
            
            liveLog(`Answer set for "${companyName}": ${answer}`, 'info');
            
            // Update submit button state
            updateSubmitButtonState();
            
            // Update manual review button state
            updateManualReviewButtonState();
            
            // Update header to show progress
            updateQuestionsProgress();
        }

        // Update questions progress
        function updateQuestionsProgress() {
            const totalQuestions = document.querySelectorAll('.question-item').length;
            const answeredQuestions = Object.keys(userAnswers).length;
            
            const headerElement = document.querySelector('.questions-header h3');
            if (headerElement) {
                headerElement.textContent = `Manual Review Questions (${answeredQuestions}/${totalQuestions} answered)`;
            }
        }

        // Skip all questions
        function skipAllQuestions() {
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                const companyNameElement = item.querySelector('code');
                if (companyNameElement) {
                    const companyName = companyNameElement.textContent;
                    setAnswer(companyName, 'skip', index);
                }
            });
            
            liveLog('All questions skipped', 'warning');
        }

        // Clear all answers
        function clearAllAnswers() {
            userAnswers = {};
            
            // Hide all answer divs
            document.querySelectorAll('[id^="answer-"]').forEach(div => {
                div.style.display = 'none';
            });
            
            // Update submit button state
            updateSubmitButtonState();
            
            // Update manual review button state
            updateManualReviewButtonState();
            
            // Update progress
            updateQuestionsProgress();
            
            liveLog('All answers cleared', 'info');
        }

        // Submit manual answers
        async function submitManualAnswers() {
            try {
                updateProgress(95, 'Submitting answers...');
                
                const answersResponse = await fetch(`${window.API_BASE_URL}/api/statement-processor/${currentSessionId}/answers`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: userAnswers })
                });
                
                if (!answersResponse.ok) {
                    throw new Error(`HTTP ${answersResponse.status}: ${answersResponse.statusText}`);
                }
                
                const answersData = await answersResponse.json();
                
                showAPIResponse('Answers Submitted', { answers: userAnswers, response: answersData }, `POST /api/statement-processor/{id}/answers`);
                liveLog(`Answers submitted: ${Object.keys(userAnswers).length} responses`, 'success');
                
                updateProgress(100, 'Processing complete! Ready for download.');
                enableDownload();
                advanceWorkflowStep('download');
                
                // Update the manual review button to show completion
                updateManualReviewButtonState();
                
                // Close modal if open
                closeManualReviewModal();
                
                // Add extra scroll to download after a brief delay
                setTimeout(() => {
                    const downloadSection = document.getElementById('downloadSection');
                    if (downloadSection) {
                        downloadSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 1000);
                
            } catch (error) {
                liveLog(`Answer submission failed: ${error.message}`, 'error');
                updateProgress(90, 'Answer submission failed. Please try again.');
                
                console.error('Answer submission failed:', error);
            }
        }

        // Enable download
        function enableDownload() {
            const responseContainer = document.getElementById('responseContainer');
            const downloadDiv = document.createElement('div');
            downloadDiv.className = 'response-viewer';
            downloadDiv.id = 'downloadSection';
            downloadDiv.innerHTML = `
                <div class="response-header">
                    <span class="direction-icon received"></span>
                    <span class="response-title">Download Results</span>
                    <span class="direction-text">Ready for Download</span>
                </div>
                <div class="endpoint-info">
                    <p>Processing complete! Click below to download your results.</p>
                </div>
                <button class="button success download-ready" onclick="downloadResults()" id="downloadBtn">
                    Download ZIP File
                </button>
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
                    <strong>Download:</strong> monthlysttmnt{mm}{yyyy}.zip with PDFs in root + logs/ folder<br>
                    <code style="color: #666;">GET /api/statement-processor/{session_id}/download</code>
                </div>
            `;
            responseContainer.appendChild(downloadDiv);
            
            // Download section ready - will auto-scroll only after manual review is complete
        }

        // Download results
        function downloadResults() {
            const downloadUrl = `${window.API_BASE_URL}/api/statement-processor/${currentSessionId}/download`;
            window.open(downloadUrl);
            liveLog('Download initiated', 'success');
        }
        
        
        // Mobile navigation toggle
        function toggleMobileNav() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('open');
        }

        // Keyboard support for modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('manualReviewModal');
                if (modal && modal.style.display === 'flex') {
                    closeManualReviewModal();
                }
            }
        });
        
        // Click on modal overlay (not content) to close
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('manualReviewModal');
            if (modal && event.target === modal && modal.style.display === 'flex') {
                closeManualReviewModal();
            }
        });
        
        // Workflow heartbeat management
        function updateWorkflowHeartbeat() {
            // Remove all workflow heartbeats first
            document.querySelectorAll('.workflow-heartbeat').forEach(el => {
                el.classList.remove('workflow-heartbeat');
            });
            
            // Add heartbeat to current step
            if (currentWorkflowStep === 'pdf_input' && !selectedFiles.pdf) {
                const pdfUpload = document.querySelector('#pdfStatus').parentElement;
                if (pdfUpload) pdfUpload.classList.add('workflow-heartbeat');
            } else if (currentWorkflowStep === 'excel_input' && selectedFiles.pdf && !selectedFiles.excel) {
                const excelUpload = document.querySelector('#excelStatus').parentElement;
                if (excelUpload) excelUpload.classList.add('workflow-heartbeat');
            } else if (currentWorkflowStep === 'process' && selectedFiles.pdf && selectedFiles.excel) {
                const processBtn = document.getElementById('startProcessing');
                if (processBtn && !processBtn.disabled) processBtn.classList.add('workflow-heartbeat');
            } else if (currentWorkflowStep === 'manual_review') {
                const reviewBtn = document.getElementById('manualReviewBtn');
                if (reviewBtn && reviewBtn.style.display !== 'none') reviewBtn.classList.add('workflow-heartbeat');
            } else if (currentWorkflowStep === 'download') {
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) downloadBtn.classList.add('workflow-heartbeat');
            }
        }
        
        function advanceWorkflowStep(nextStep) {
            currentWorkflowStep = nextStep;
            updateWorkflowHeartbeat();
        }
        
        // Memory System Functions
        async function checkMemorySystemStatus() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/stats`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('memorySystemStatus').textContent = 'Online';
                    document.getElementById('memorySystemStatus').className = 'status-indicator status-connected';
                    document.getElementById('memoryCompaniesCount').textContent = `${data.total_companies} companies`;
                    document.getElementById('memoryDecisionsCount').textContent = `${data.total_questions} decisions`;
                } else {
                    document.getElementById('memorySystemStatus').textContent = 'Offline';
                    document.getElementById('memorySystemStatus').className = 'status-indicator status-disconnected';
                }
            } catch (error) {
                document.getElementById('memorySystemStatus').textContent = 'Error';
                document.getElementById('memorySystemStatus').className = 'status-indicator status-disconnected';
            }
        }

        async function testMemorySystem() {
            const resultsDiv = document.getElementById('memoryTestResults');
            resultsDiv.innerHTML = '<p>Testing memory system...</p>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/stats`);
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="test-result success">
                        <h5>✅ Memory System Test Successful</h5>
                        <div class="test-details">
                            <p><strong>Companies stored:</strong> ${data.total_companies}</p>
                            <p><strong>Total decisions:</strong> ${data.total_questions}</p>
                            <p><strong>Confirmed matches:</strong> ${data.total_matches}</p>
                            <p><strong>Average similarity:</strong> ${data.avg_similarity.toFixed(1)}%</p>
                            <p><strong>System initialized:</strong> ${data.system_initialized}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        <h5>❌ Memory System Test Failed</h5>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testCompaniesEndpoint() {
            const resultsDiv = document.getElementById('memoryTestResults');
            resultsDiv.innerHTML = '<p>Testing companies endpoint...</p>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/companies`);
                const data = await response.json();
                
                const companiesCount = data.companies ? data.companies.length : 0;
                const firstCompany = data.companies && data.companies.length > 0 ? data.companies[0] : null;
                
                resultsDiv.innerHTML = `
                    <div class="test-result success">
                        <h5>✅ Companies Endpoint Test Successful</h5>
                        <div class="test-details">
                            <p><strong>Total companies:</strong> ${companiesCount}</p>
                            ${firstCompany ? `
                                <p><strong>Example company:</strong> "${firstCompany.extracted_company}"</p>
                                <p><strong>Decisions for example:</strong> ${firstCompany.equivalences.length}</p>
                                <p><strong>Confirmed matches:</strong> ${firstCompany.confirmed_matches}</p>
                            ` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        <h5>❌ Companies Endpoint Test Failed</h5>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Live Memory Testing Functions
        async function liveTestMemoryStats() {
            const resultsDiv = document.getElementById('liveMemoryStatsResult');
            resultsDiv.innerHTML = '<div style="background: rgba(251, 191, 36, 0.15); border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-top: 8px; color: #fbbf24; font-weight: 500; text-align: center;">Testing...</div>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/stats`);
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div style="background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #4ade80; margin: 0 0 8px 0; font-weight: 600;">✅ Success (${response.status})</h5>
                        <div style="background: rgba(0,0,0,0.6); border-radius: 4px; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1);">
                            <pre style="margin: 0; font-size: 13px; color: #e2e8f0; line-height: 1.4;">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p style="font-size: 13px; color: #cbd5e1; margin: 4px 0 0 0; font-weight: 500;">Companies: ${data.total_companies} | Decisions: ${data.total_questions} | Matches: ${data.total_matches}</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #f87171; margin: 0 0 8px 0; font-weight: 600;">❌ Error</h5>
                        <p style="color: #fca5a5; margin: 0; font-size: 13px; font-weight: 500;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function liveTestCompaniesList() {
            const resultsDiv = document.getElementById('liveCompaniesResult');
            resultsDiv.innerHTML = '<div style="background: rgba(251, 191, 36, 0.15); border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-top: 8px; color: #fbbf24; font-weight: 500; text-align: center;">Testing...</div>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/companies`);
                const data = await response.json();
                
                const companiesCount = data.companies ? data.companies.length : 0;
                const firstFew = data.companies ? data.companies.slice(0, 2) : [];
                
                resultsDiv.innerHTML = `
                    <div style="background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #4ade80; margin: 0 0 8px 0; font-weight: 600;">✅ Success (${response.status})</h5>
                        <p style="color: #f1f5f9; font-size: 14px; margin: 4px 0; font-weight: 500;">Found ${companiesCount} companies with stored decisions</p>
                        ${firstFew.length > 0 ? `
                            <div style="background: rgba(0,0,0,0.6); border-radius: 4px; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 6px; font-weight: 600;">Sample companies:</div>
                                ${firstFew.map(company => `
                                    <div style="color: #e2e8f0; font-size: 13px; margin: 3px 0; padding: 2px 0;">
                                        • "${company.extracted_company}" (${company.equivalences.length} decisions)
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <details style="margin-top: 8px;">
                            <summary style="color: #cbd5e1; font-size: 12px; cursor: pointer; font-weight: 500;">Show full JSON response</summary>
                            <div style="background: rgba(0,0,0,0.6); border-radius: 4px; padding: 12px; margin: 4px 0; border: 1px solid rgba(255,255,255,0.1);">
                                <pre style="margin: 0; font-size: 11px; color: #e2e8f0; max-height: 200px; overflow-y: auto; line-height: 1.4;">${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #f87171; margin: 0 0 8px 0; font-weight: 600;">❌ Error</h5>
                        <p style="color: #fca5a5; margin: 0; font-size: 13px; font-weight: 500;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function liveTestStoreDecision() {
            const resultsDiv = document.getElementById('liveStoreResult');
            const extractedCompany = document.getElementById('liveExtractedCompany').value;
            const dnmCompany = document.getElementById('liveDnmCompany').value;
            const userDecision = document.getElementById('liveUserDecision').value === 'true';

            if (!extractedCompany || !dnmCompany) {
                resultsDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #f87171; margin: 0 0 8px 0; font-weight: 600;">❌ Input Error</h5>
                        <p style="color: #fca5a5; margin: 0; font-size: 13px; font-weight: 500;">Please fill in both company names</p>
                    </div>
                `;
                return;
            }

            resultsDiv.innerHTML = '<div style="background: rgba(251, 191, 36, 0.15); border: 1px solid #fbbf24; border-radius: 6px; padding: 12px; margin-top: 8px; color: #fbbf24; font-weight: 500; text-align: center;">Testing...</div>';
            
            const requestData = {
                extracted_company: extractedCompany,
                dnm_company: dnmCompany,
                user_decision: userDecision,
                similarity_percentage: 75.0,
                session_id: 'live-test-' + Date.now()
            };
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/company-memory/store`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div style="background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #4ade80; margin: 0 0 8px 0; font-weight: 600;">✅ Success (${response.status})</h5>
                        <p style="color: #f1f5f9; font-size: 14px; margin: 4px 0; font-weight: 500;">Decision stored: "${extractedCompany}" ${userDecision ? '=' : '≠'} "${dnmCompany}"</p>
                        <div style="background: rgba(0,0,0,0.6); border-radius: 4px; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 6px; font-weight: 600;">Request sent:</div>
                            <pre style="margin: 0 0 10px 0; font-size: 11px; color: #94a3b8; line-height: 1.4;">${JSON.stringify(requestData, null, 2)}</pre>
                            <div style="font-size: 13px; color: #cbd5e1; margin-bottom: 6px; font-weight: 600;">Response received:</div>
                            <pre style="margin: 0; font-size: 11px; color: #e2e8f0; line-height: 1.4;">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; border-radius: 6px; padding: 12px; margin-top: 8px; color: #ffffff;">
                        <h5 style="color: #f87171; margin: 0 0 8px 0; font-weight: 600;">❌ Error</h5>
                        <p style="color: #fca5a5; margin: 0; font-size: 13px; font-weight: 500;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-test API connection if in live mode
            if (isLiveMode) {
                testAPIConnection();
            }
            // Check memory system status
            checkMemorySystemStatus();
            // Start workflow heartbeat on PDF input
            updateWorkflowHeartbeat();
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            detailedLog(' Page loaded, testing API connection...', 'info');
            showTab('overview');
            testAPIConnection();
            
            // Initialize workflow heartbeat when switching to live mode
            if (isLiveMode) {
                updateWorkflowHeartbeat();
            }
            
            // Close mobile nav when clicking outside
            document.addEventListener('click', function(event) {
                const navLinks = document.querySelector('.nav-links');
                const toggle = document.querySelector('.mobile-nav-toggle');
                
                if (!navLinks.contains(event.target) && !toggle.contains(event.target)) {
                    navLinks.classList.remove('open');
                }
            });
        });
    </script>
</body>
</html>